(()=>{var C=class{constructor(t){this.forward=!1;this.left=!1;this.right=!1;this.reverse=!1;switch(t){case"KEYS":this.addKeyboardListeners();break;case"DUMMY":this.forward=!0;break;case"AI":break}}addKeyboardListeners(){document.onkeydown=t=>{switch(t.key){case"ArrowUp":this.forward=!0;break;case"ArrowLeft":this.left=!0;break;case"ArrowRight":this.right=!0;break;case"ArrowDown":this.reverse=!0;break;default:break}},document.onkeyup=t=>{switch(t.key){case"ArrowUp":this.forward=!1;break;case"ArrowLeft":this.left=!1;break;case"ArrowRight":this.right=!1;break;case"ArrowDown":this.reverse=!1;break;default:break}}}};function d(r,t,e){return r+(t-r)*e}var u=class{constructor(t,e){this.x=t;this.y=e}},E=class extends u{constructor(e,s){super(e.x,e.y);this.offset=s}};function D(r,t,e,s){let n=(s.x-e.x)*(r.y-e.y)-(s.y-e.y)*(r.x-e.x),i=(e.y-r.y)*(r.x-t.x)-(e.x-r.x)*(r.y-t.y),l=(s.y-e.y)*(t.x-r.x)-(s.x-e.x)*(t.y-r.y);if(l===0)return null;let o=n/l,a=i/l;return o>=0&&o<=1&&a>=0&&a<=1?new E(new u(d(r.x,t.x,o),d(r.y,t.y,o)),o):null}function X(r,t){return Math.floor(Math.random()*(t-r+1))+r}function L(r,t){for(let e=0;e<r.length;e++){let s=r[e],n=r[(e+1)%r.length];for(let i=0;i<t.length;i++){let l=t[i],o=t[(i+1)%t.length];if(D(s,n,l,o))return!0}}return!1}function I(r){let t=Math.abs(r),e=r<0?0:255,s=e,n=r>0?0:255;return"rgba("+e+","+s+","+n+","+t+")"}var v=class{constructor(t){this.levels=[],this.fitness=0;for(let e=0;e<t.length-1;e++)this.levels.push(new w(t[e],t[e+1]))}static feedForward(t,e){let s=w.feedForward(t,e.levels[0]);for(let n=1;n<e.levels.length;n++)s=w.feedForward(s,e.levels[n]);return s}static mutate(t,e=1){t.levels.forEach(s=>{for(let n=0;n<s.biases.length;n++)s.biases[n]=d(s.biases[n],Math.random()*2-1,e);for(let n=0;n<s.weights.length;n++)for(let i=0;i<s.weights[n].length;i++)s.weights[n][i]=d(s.weights[n][i],Math.random()*2-1,e)})}},w=class{constructor(t,e){this.inputCount=t;this.outputCount=e;this.inputs=new Array(t),this.outputs=new Array(e),this.biases=new Array(e),this.weights=new Array(t);for(let s=0;s<t;s++)this.weights[s]=new Array(e);w.randomize(this)}static randomize(t){for(let e=0;e<t.inputs.length;e++)for(let s=0;s<t.outputs.length;s++)t.weights[e][s]=Math.random()*2-1;for(let e=0;e<t.biases.length;e++)t.biases[e]=Math.random()*2-1}static feedForward(t,e){for(let s=0;s<e.inputs.length;s++)e.inputs[s]=t[s];for(let s=0;s<e.outputs.length;s++){let n=0;for(let i=0;i<e.outputs.length;i++)n+=e.inputs[i]*e.weights[i][s];e.outputs[s]=n>e.biases[s]?1:0}return e.outputs}};var A=class{constructor(t,e=10,s=200,n=Math.PI/2){this.car=t;this.rayCount=e;this.rayLength=s;this.raySpread=n;this.rays=[],this.readings=[]}update(t,e){this.castRays(),this.readings=[];for(let s=0;s<this.rays.length;s++)this.readings.push(this.getReading(this.rays[s],t,e))}draw(t){for(let e=0;e<this.rayCount;e++){let s=this.readings[e]??this.rays[e][1];t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}castRays(){this.rays=[];for(let t=0;t<this.rayCount;t++){let e=d(this.raySpread/2,-this.raySpread/2,this.rayCount===1?.5:t/(this.rayCount-1))+this.car.angle,s=new u(this.car.x,this.car.y),n=new u(this.car.x-Math.sin(e)*this.rayLength,this.car.y-Math.cos(e)*this.rayLength);this.rays.push([s,n])}}getReading(t,e,s){let n=[];for(let o of e){let a=D(t[0],t[1],o[0],o[1]);a&&n.push(a)}for(let o of s)for(let a=0;a<o.polygon.length;a++){let g=D(t[0],t[1],o.polygon[a],o.polygon[(a+1)%o.polygon.length]);g&&n.push(g)}if(n.length===0)return null;let i=n.map(o=>o.offset),l=Math.min(...i);return n.find(o=>o.offset===l)??null}};var R=class{constructor(t,e,s,n,i,l=3,o=.2){this.x=t;this.y=e;this.height=s;this.width=n;this.controlType=i;this.maxSpeed=l;this.acceleration=o;this.lastY=0;this.behind=0;this.lastBehind=0;this.controls=new C(i),this.polygon=[],this.damaged=!1,this.controlType==="AI"&&(this.sensor=new A(this),this.brain=new v([this.sensor.rayCount,6,4])),this.speed=0,this.angle=0}update(t,e,s){if(this.damaged||(this.behind=s.filter(n=>n.y>this.y).length,this.move(t/5),this.polygon=this.createPolygon(),this.damaged=this.assessDamage(e,s)),this.sensor&&this.brain){this.damaged?this.brain.fitness-=300:(this.brain.fitness+=(this.lastY-this.y)/5,this.lastY=this.y,this.behind!==this.lastBehind&&(this.brain.fitness+=(this.behind-this.lastBehind)*300,this.lastBehind=this.behind),this.speed<this.maxSpeed*.5&&(this.brain.fitness-=(this.maxSpeed-this.speed)*2),this.controls.forward&&this.controls.reverse&&(this.brain.fitness-=10),this.controls.left&&this.controls.right&&(this.brain.fitness-=10)),this.sensor.update(e,s);let n=this.sensor.readings.map(l=>l===null?0:1-l.offset),i=v.feedForward(n,this.brain);this.controlType==="AI"&&(this.controls.forward=!!i[0],this.controls.left=!!i[1],this.controls.right=!!i[2],this.controls.reverse=!!i[3])}}assessDamage(t,e){for(let s=0;s<t.length;s++)if(L(this.polygon,t[s]))return!0;for(let s=0;s<e.length;s++)if(L(this.polygon,e[s].polygon))return!0;return!1}createPolygon(){let t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push(new u(this.x-Math.sin(this.angle-s)*e,this.y-Math.cos(this.angle-s)*e)),t.push(new u(this.x-Math.sin(this.angle+s)*e,this.y-Math.cos(this.angle+s)*e)),t.push(new u(this.x-Math.sin(Math.PI+this.angle-s)*e,this.y-Math.cos(Math.PI+this.angle-s)*e)),t.push(new u(this.x-Math.sin(Math.PI+this.angle+s)*e,this.y-Math.cos(Math.PI+this.angle+s)*e)),t}move(t){this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed&&(this.speed=-this.maxSpeed),this.speed*=R.friction;let e=this.speed<0?-1:1;this.controls.left&&(this.angle+=.009*e*t),this.controls.right&&(this.angle-=.009*e*t),this.x-=Math.sin(this.angle)*this.speed*t,this.y-=Math.cos(this.angle)*this.speed*t}draw(t,e,s=!1){this.damaged?t.fillStyle="gray":t.fillStyle=e,t.beginPath(),t.moveTo(this.polygon[0].x,this.polygon[0].y);for(let n=1;n<this.polygon.length;n++)t.lineTo(this.polygon[n].x,this.polygon[n].y);t.closePath(),t.fill(),s&&this.sensor&&this.sensor.draw(t)}},M=R;M.friction=.9;var N=class{constructor(t,e,s=3){this.x=t;this.width=e;this.laneCount=s;this.left=t-e/2,this.right=t+e/2,this.top=-1e6,this.bottom=1e6;let n=new u(this.left,-Number.MAX_SAFE_INTEGER),i=new u(this.left,Number.MAX_SAFE_INTEGER),l=new u(this.right,-Number.MAX_SAFE_INTEGER),o=new u(this.right,Number.MAX_SAFE_INTEGER);this.borders=[[n,i],[l,o]]}getLaneCenter(t){let e=this.width/this.laneCount;return this.left+e*(t%this.laneCount)+e/2}draw(t){t.lineWidth=5,t.strokeStyle="white";for(let e=1;e<=this.laneCount-1;e++){let s=d(this.left,this.right,e/this.laneCount);t.setLineDash([20,20]),t.beginPath(),t.moveTo(s,this.top),t.lineTo(s,this.bottom),t.stroke()}t.setLineDash([]);for(let e of this.borders)t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()}};var m=class{static drawNetwork(t,e){let l=t.canvas.width-100,o=t.canvas.height-50*2-50,a=o/e.levels.length;for(let g=e.levels.length-1;g>=0;g--){let y=100+d(o-a,0,e.levels.length==1?.5:g/(e.levels.length-1));t.setLineDash([7,3]),m.drawLevel(t,e.levels[g],50,y,l,a,g==e.levels.length-1?["\u{1F809}","\u{1F808}","\u{1F80A}","\u{1F80B}"]:[])}t.save(),t.font="10px Arial",t.fillStyle="white",t.fillText("Fitness",t.canvas.width/2,35),t.fillText(e.fitness.toFixed(0),t.canvas.width/2,50),t.restore()}static drawLevel(t,e,s,n,i,l,o){let a=s+i,g=n+l,{inputs:y,outputs:S,weights:H,biases:K}=e;for(let h=0;h<y.length;h++)for(let f=0;f<S.length;f++)t.beginPath(),t.moveTo(m.getNodeX(y,h,s,a),g),t.lineTo(m.getNodeX(S,f,s,a),n),t.lineWidth=2,t.strokeStyle=I(H[h][f]),t.stroke();let p=18;for(let h=0;h<y.length;h++){let f=m.getNodeX(y,h,s,a);t.beginPath(),t.arc(f,g,p,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(f,g,p*.6,0,Math.PI*2),t.fillStyle=I(y[h]),t.fill()}for(let h=0;h<S.length;h++){let f=m.getNodeX(S,h,s,a);t.beginPath(),t.arc(f,n,p,0,Math.PI*2),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(f,n,p*.6,0,Math.PI*2),t.fillStyle=I(S[h]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(f,n,p*.8,0,Math.PI*2),t.strokeStyle=I(K[h]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),o[h]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font=p*1.5+"px Arial",t.fillText(o[h],f,n+p*.1),t.lineWidth=.5,t.strokeText(o[h],f,n+p*.1))}}static getNodeX(t,e,s,n){return d(s,n,t.length==1?.5:e/(t.length-1))}};var k=document.getElementById("carCanvas");k.width=200;var c=k.getContext("2d"),W=document.getElementById("networkCanvas");W.width=300;var Y=W.getContext("2d"),P=new N(k.width/2,k.width*.9,3),b=q(1e3);function q(r){let t=[];for(let e=0;e<r;e++)t.push(new M(P.getLaneCenter(1),-100,50,30,"AI",1));return t}var B=x(50);window.requestAnimationFrame(O);var T=b[0];if(localStorage.getItem("bestBrain"))for(let r=0;r<b.length;r++)b[r].brain=JSON.parse(localStorage.getItem("bestBrain")),r!=0&&v.mutate(b[r].brain,.05);localStorage.getItem("autorefresh")?F(!0):F(!1);document.getElementById("save-button")?.addEventListener("click",j);document.getElementById("delete-button")?.addEventListener("click",J);document.getElementById("autorefresh-button")?.addEventListener("click",_);function j(){localStorage.setItem("bestBrain",JSON.stringify(T.brain))}function J(){localStorage.removeItem("bestBrain")}function _(){F(!localStorage.getItem("autorefresh"))}var G;function F(r){r?(localStorage.setItem("autorefresh","true"),document.getElementById("autorefresh-button").innerText="\u{1F503}",G=window.setTimeout(()=>{j(),window.location.reload()},1e3*60)):(localStorage.removeItem("autorefresh"),document.getElementById("autorefresh-button").innerText="\u26D4",window.clearTimeout(G))}var U=0;function O(r){let t=r-U;U=r,k.height=window.innerHeight,W.height=window.innerHeight,T=b.find(e=>e.brain.fitness===Math.max(...b.map(s=>s.brain.fitness)));for(let e of B)e.update(t,P.borders,[]);for(let e=0;e<b.length;e++)b[e].update(t,P.borders,B);c.save(),c.translate(0,-T.y+k.height*.7),P.draw(c);for(let e of B)e.draw(c,"darkred");c.globalAlpha=.2;for(let e=0;e<b.length;e++)b[e].draw(c,"darkblue");c.globalAlpha=1,T.draw(c,"darkblue",!0),c.restore(),Y.lineDashOffset=-r/50,m.drawNetwork(Y,T.brain),window.requestAnimationFrame(O)}function x(r){let t=[];for(let e=0;e<r;e++){let s=X(0,P.laneCount);t.push(new M(P.getLaneCenter(s),-200+-150*e,50,30,"DUMMY",.6)),Math.random()>.5&&e<r-1&&(t.push(new M(P.getLaneCenter(s+1),-200+-150*e,50,30,"DUMMY",.6)),e+=1)}return t}})();
